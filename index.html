<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earth's Mood Ring 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #050505;
            color: white;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
        }

        .mood-happy { --mood-color: #00ff88; --mood-bg: rgba(0, 255, 136, 0.1); }
        .mood-neutral { --mood-color: #00d1ff; --mood-bg: rgba(0, 209, 255, 0.1); }
        .mood-sad { --mood-color: #ffaa00; --mood-bg: rgba(255, 170, 0, 0.1); }
        .mood-critical { --mood-color: #ff3366; --mood-bg: rgba(255, 51, 102, 0.1); }

        .mood-border { border-color: var(--mood-color); }
        .mood-text { color: var(--mood-color); }
        .mood-glow { box-shadow: 0 0 20px var(--mood-bg); }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .ui-layer {
            position: relative;
            z-index: 10;
            pointer-events: none;
        }

        .interactive { pointer-events: auto; }

        input, button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .shimmer {
            background: linear-gradient(90deg, #111 25%, #222 50%, #111 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="mood-neutral">

    <div id="loader" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center p-6">
        <div class="w-24 h-24 rounded-full border-4 border-t-cyan-500 border-r-transparent border-b-transparent border-l-transparent animate-spin mb-8"></div>
        <h1 class="text-3xl font-extrabold tracking-tighter mb-2">CALIBRATING EARTH...</h1>
        <p class="text-zinc-500 animate-pulse">Fetching environmental bio-metrics</p>
    </div>

    <div id="canvas-container"></div>

    <main class="ui-layer min-h-screen flex flex-col justify-between p-4 md:p-8">
        <!-- Header Section -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="interactive glass p-4 px-6 flex items-center gap-4">
                <div id="mood-indicator" class="w-4 h-4 rounded-full mood-glow mood-happy bg-[var(--mood-color)] animate-ping"></div>
                <div>
                    <h1 class="font-bold text-xl tracking-tight">EARTH'S MOOD</h1>
                    <p id="current-mood-label" class="text-xs uppercase tracking-[0.2em] opacity-60">Status: Healthy</p>
                </div>
            </div>

            <div class="interactive glass p-2 flex items-center">
                <input id="location-input" type="text" placeholder="Search City..." class="bg-transparent border-none outline-none px-4 py-2 w-48 md:w-64 text-sm font-medium">
                <button id="search-btn" class="bg-white/10 hover:bg-white/20 p-2 px-4 rounded-xl text-sm font-bold uppercase transition-all">Go</button>
            </div>
        </header>

        <!-- Stats Panel -->
        <div class="flex flex-col md:flex-row items-end justify-between gap-6">
            <div class="interactive glass p-6 w-full md:w-80 flex flex-col gap-4">
                <h2 class="font-bold text-lg border-b border-white/10 pb-2">Global Vitals</h2>
                
                <div class="flex justify-between items-center">
                    <span class="text-sm opacity-60">Temperature</span>
                    <span id="stat-temp" class="font-bold text-cyan-400">22°C</span>
                </div>
                <div class="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
                    <div id="bar-temp" class="h-full bg-cyan-400 w-1/2 transition-all duration-700"></div>
                </div>

                <div class="flex justify-between items-center">
                    <span class="text-sm opacity-60">Air Quality (AQI)</span>
                    <span id="stat-aqi" class="font-bold text-emerald-400">Good (12)</span>
                </div>
                <div class="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
                    <div id="bar-aqi" class="h-full bg-emerald-400 w-[15%] transition-all duration-700"></div>
                </div>

                <div class="flex justify-between items-center">
                    <span class="text-sm opacity-60">Carbon Density</span>
                    <span id="stat-carbon" class="font-bold text-rose-400">Nominal</span>
                </div>
            </div>

            <div class="interactive flex flex-col gap-3 items-end">
                <div class="glass p-4 text-right">
                    <p id="local-time" class="text-2xl font-black tracking-tighter">00:00:00</p>
                    <p id="local-date" class="text-[10px] uppercase opacity-40 tracking-widest">Planet Earth • 2024</p>
                </div>
                
                <div class="flex gap-2">
                    <button class="glass p-3 px-6 text-xs font-bold uppercase hover:bg-white/10 transition-all">Share Mood</button>
                    <button id="toggle-rotation" class="glass p-3 px-6 text-xs font-bold uppercase hover:bg-white/10 transition-all">Pause Spin</button>
                </div>
            </div>
        </div>
    </main>

    <div id="location-marker" class="fixed pointer-events-none hidden">
        <div class="w-6 h-6 -ml-3 -mt-3 rounded-full border-2 border-white animate-ping"></div>
        <div class="absolute top-8 left-1/2 -translate-x-1/2 whitespace-nowrap glass px-3 py-1 text-[10px] font-bold uppercase">Target Point</div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let scene, camera, renderer, earth, clouds, stars, particles;
        let isRotating = true;
        let moodScore = 80; // 0-100 (100 is best)
        let currentCity = "London";
        let targetRotationX = 0;
        let targetRotationY = 0;

        // --- INITIALIZATION ---
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 2.5;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
            sunLight.position.set(5, 3, 5);
            scene.add(sunLight);

            // Earth
            const earthGeometry = new THREE.SphereGeometry(1, 64, 64);
            const earthMaterial = new THREE.MeshPhongMaterial({
                color: 0x2233ff,
                emissive: 0x112244,
                specular: 0x555555,
                shininess: 5,
                flatShading: false
            });
            earth = new THREE.Mesh(earthGeometry, earthMaterial);
            scene.add(earth);

            // Atmosphere / Clouds
            const cloudGeometry = new THREE.SphereGeometry(1.03, 64, 64);
            const cloudMaterial = new THREE.MeshPhongMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.3
            });
            clouds = new THREE.Mesh(cloudGeometry, cloudMaterial);
            scene.add(clouds);

            // Stars
            const starGeometry = new THREE.BufferGeometry();
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.015 });
            const starCoords = [];
            for(let i=0; i<3000; i++) {
                starCoords.push((Math.random()-0.5)*20, (Math.random()-0.5)*20, (Math.random()-0.5)*20);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starCoords, 3));
            stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);

            // Pollution Particles
            createPollutionParticles(0);

            animate();
            
            // Initial Data Fetch
            fetchData("London");
        }

        function createPollutionParticles(count) {
            if (particles) scene.remove(particles);
            if (count === 0) return;

            const partGeo = new THREE.BufferGeometry();
            const partCoords = [];
            for(let i=0; i<count; i++) {
                const r = 1.05 + Math.random() * 0.2;
                const phi = Math.random() * Math.PI * 2;
                const theta = Math.random() * Math.PI;
                partCoords.push(
                    r * Math.sin(theta) * Math.cos(phi),
                    r * Math.sin(theta) * Math.sin(phi),
                    r * Math.cos(theta)
                );
            }
            partGeo.setAttribute('position', new THREE.Float32BufferAttribute(partCoords, 3));
            const partMat = new THREE.PointsMaterial({ color: 0x666666, size: 0.01, transparent: true, opacity: 0.5 });
            particles = new THREE.Points(partGeo, partMat);
            scene.add(particles);
        }

        // --- DATA FETCHING ---
        async function fetchData(city) {
            try {
                // Get Coordinates
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=en&format=json`);
                const geoData = await geoRes.json();
                
                if (!geoData.results || geoData.results.length === 0) {
                    showStatus("City not found", "critical");
                    return;
                }

                const { latitude, longitude, name } = geoData.results[0];
                currentCity = name;

                // Weather + Air Quality Parallel Fetch
                const [weatherRes, aqRes] = await Promise.all([
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`),
                    fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${latitude}&longitude=${longitude}&current=pm2_5,pm10`)
                ]);

                const weatherData = await weatherRes.json();
                const aqData = await aqRes.json();

                updateUI(weatherData.current_weather, aqData.current, name);
                updateEarthMood(weatherData.current_weather.temperature, aqData.current.pm2_5);
                rotateToLocation(latitude, longitude);

                document.getElementById('loader').style.display = 'none';

            } catch (error) {
                console.error("Fetch error:", error);
                showStatus("Network Error", "critical");
            }
        }

        function rotateToLocation(lat, lon) {
            // Convert lat/lon to 3D rotation
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            
            gsap.to(earth.rotation, {
                x: phi - Math.PI/2,
                y: -theta + Math.PI/2,
                duration: 2,
                ease: "power2.inOut"
            });
            isRotating = false;
            document.getElementById('toggle-rotation').innerText = "Resume Spin";
        }

        function updateUI(weather, aq, name) {
            document.getElementById('stat-temp').innerText = `${weather.temperature}°C`;
            document.getElementById('bar-temp').style.width = `${Math.min(Math.max((weather.temperature + 10) * 2, 5), 100)}%`;
            
            const pm25 = aq.pm2_5;
            let aqStatus = "Good";
            let aqColor = "#00ff88";
            if (pm25 > 50) { aqStatus = "Moderate"; aqColor = "#ffaa00"; }
            if (pm25 > 100) { aqStatus = "Unhealthy"; aqColor = "#ff3366"; }

            document.getElementById('stat-aqi').innerText = `${aqStatus} (${Math.round(pm25)})`;
            document.getElementById('stat-aqi').style.color = aqColor;
            document.getElementById('bar-aqi').style.width = `${Math.min(pm25, 100)}%`;
            document.getElementById('bar-aqi').style.backgroundColor = aqColor;
        }

        function updateEarthMood(temp, pm25) {
            // Calculate a score out of 100
            // Ideal: temp 20, pm25 < 10
            let score = 100;
            if (temp > 30) score -= (temp - 30) * 2;
            if (temp < 0) score -= Math.abs(temp) * 1.5;
            score -= pm25 * 0.5;
            
            score = Math.max(0, Math.min(100, score));
            
            const body = document.body;
            const label = document.getElementById('current-mood-label');
            const indicator = document.getElementById('mood-indicator');

            body.classList.remove('mood-happy', 'mood-neutral', 'mood-sad', 'mood-critical');
            
            if (score > 80) {
                body.classList.add('mood-happy');
                label.innerText = "Status: Thriving";
                earth.material.color.setHex(0x22ff88);
                createPollutionParticles(0);
            } else if (score > 50) {
                body.classList.add('mood-neutral');
                label.innerText = "Status: Stable";
                earth.material.color.setHex(0x22aaff);
                createPollutionParticles(100);
            } else if (score > 25) {
                body.classList.add('mood-sad');
                label.innerText = "Status: Stressed";
                earth.material.color.setHex(0xffaa22);
                createPollutionParticles(500);
            } else {
                body.classList.add('mood-critical');
                label.innerText = "Status: Critical";
                earth.material.color.setHex(0xff3333);
                createPollutionParticles(1500);
            }
        }

        function showStatus(msg, type) {
            const label = document.getElementById('current-mood-label');
            label.innerText = msg;
            setTimeout(() => fetchData(currentCity), 3000);
        }

        // --- INTERACTION ---
        document.getElementById('search-btn').addEventListener('click', () => {
            const city = document.getElementById('location-input').value;
            if (city) fetchData(city);
        });

        document.getElementById('location-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const city = document.getElementById('location-input').value;
                if (city) fetchData(city);
            }
        });

        document.getElementById('toggle-rotation').addEventListener('click', () => {
            isRotating = !isRotating;
            document.getElementById('toggle-rotation').innerText = isRotating ? "Pause Spin" : "Resume Spin";
        });

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            if (isRotating) {
                earth.rotation.y += 0.002;
                clouds.rotation.y += 0.0025;
            } else {
                clouds.rotation.y += 0.0005;
            }

            stars.rotation.y += 0.0002;

            if (particles) {
                particles.rotation.y += 0.001;
            }

            renderer.render(scene, camera);
        }

        // --- UTILS ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function updateClock() {
            const now = new Date();
            document.getElementById('local-time').innerText = now.toLocaleTimeString('en-GB', { hour12: false });
            document.getElementById('local-date').innerText = `PLANET EARTH • ${now.getFullYear()}`;
        }
        setInterval(updateClock, 1000);

        // Start App
        window.onload = initThree;
    </script>
</body>
</html>

