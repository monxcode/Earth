<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Pulse - AI Powered Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        body { margin: 0; overflow: hidden; font-family: 'Plus Jakarta Sans', sans-serif; background-color: #000; color: white; touch-action: manipulation; }
        
        /* Modern Loader Styles */
        #loading-overlay { 
            z-index: 9999; 
            background: radial-gradient(circle at center, #0a0a0f 0%, #000 100%); 
            transition: all 1s cubic-bezier(0.8, 0, 0.2, 1);
        }

        .loader-content {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pulse-logo {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 0.5em;
            background: linear-gradient(to right, #fff 20%, #3b82f6 50%, #fff 80%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
            margin-bottom: 2rem;
            position: relative;
        }

        @keyframes shine {
            to { background-position: 200% center; }
        }

        .scan-line {
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            position: absolute;
            top: 0;
            animation: scan 2s ease-in-out infinite;
            opacity: 0.5;
        }

        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }

        .progress-container {
            width: 280px;
            height: 2px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: #3b82f6;
            box-shadow: 0 0 15px #3b82f6;
            transition: width 0.4s ease;
        }

        .status-text {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            color: #3b82f6;
            margin-top: 15px;
            font-weight: 800;
            opacity: 0.6;
        }

        .grid-bg {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black, transparent 80%);
            animation: grid-move 20s linear infinite;
        }

        @keyframes grid-move {
            from { background-position: 0 0; }
            to { background-position: 50px 50px; }
        }

        /* App UI Styles */
        .interactive { 
            pointer-events: auto; 
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease;
            cursor: pointer;
        }
        .interactive:active { transform: scale(0.95); }

        .glass { background: rgba(5, 5, 12, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .ui-layer { position: relative; z-index: 10; pointer-events: none; height: 100vh; display: flex; flex-direction: column; }
        
        #menu-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; pointer-events: none; transition: opacity 0.4s ease; z-index: 90;
        }
        #menu-backdrop.open { opacity: 1; pointer-events: auto; }

        #side-menu {
            transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1); z-index: 100;
        }
        #side-menu.open { transform: translateX(0); }

        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255,255,255,0.1); transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(20px); }

        .risk-badge { padding: 4px 10px; border-radius: 50px; font-size: 8px; font-weight: 800; text-transform: uppercase; }
        
        .noise-dot {
            width: 3px; height: 3px; background: currentColor; border-radius: 50%;
            animation: dot-pulse 0.5s ease-in-out infinite alternate;
        }
        @keyframes dot-pulse {
            from { transform: scale(0.8); opacity: 0.3; }
            to { transform: scale(1.5); opacity: 1; }
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        /* AI Content Formatting Styles */
        #ai-content h3 { font-size: 1.1rem; font-weight: 800; color: #3b82f6; margin-top: 1.5rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        #ai-content p { margin-bottom: 0.75rem; color: rgba(255, 255, 255, 0.8); }
        #ai-content ul { list-style-type: none; padding-left: 0; margin-bottom: 1rem; }
        #ai-content li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; color: rgba(255, 255, 255, 0.9); }
        #ai-content li::before { content: "•"; position: absolute; left: 0; color: #3b82f6; font-weight: bold; }
        #ai-content strong { color: #fff; font-weight: 700; }

        /* Modal for AI */
        #ai-modal { z-index: 1000; opacity: 0; pointer-events: none; transition: all 0.3s ease; }
        #ai-modal.open { opacity: 1; pointer-events: auto; }

        /* Collapsible Section */
        #cities-collapse { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        #cities-collapse.expanded { max-height: 1000px; }
        .chevron { transition: transform 0.3s ease; }
        .expanded .chevron { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-black">

    <!-- Modern Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 flex items-center justify-center overflow-hidden">
        <div class="grid-bg"></div>
        <div class="loader-content">
            <div class="pulse-logo">GLOBAL PULSE</div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar"></div>
                <div class="scan-line"></div>
            </div>
            <div id="status-text" class="status-text">Initializing Systems...</div>
        </div>
    </div>

    <!-- AI Insights Modal -->
    <div id="ai-modal" class="fixed inset-0 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md" onclick="toggleAIModal(false)"></div>
        <div class="glass relative w-full max-w-2xl max-h-[85vh] overflow-hidden flex flex-col shadow-2xl border-blue-500/30">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-blue-500/5">
                <div>
                    <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-400">Gemini AI Analysis ✨</h2>
                    <p id="ai-city-name" class="text-xl font-bold">Delhi, India</p>
                </div>
                <button onclick="toggleAIModal(false)" class="interactive p-2 hover:bg-white/10 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round"></path></svg>
                </button>
            </div>
            <div id="ai-content" class="p-8 overflow-y-auto custom-scroll text-sm leading-relaxed">
                <!-- Content injected here -->
            </div>
            <div class="p-4 bg-white/5 text-[9px] uppercase font-bold tracking-widest text-center opacity-40 border-t border-white/5">
                Processed via Gemini 2.5 Flash Engine
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>
    <div id="menu-backdrop"></div>

    <!-- Side Menu -->
    <div id="side-menu" class="fixed top-0 right-0 h-full w-full sm:w-[350px] glass rounded-none border-l border-white/10 flex flex-col shadow-2xl">
        <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
            <div>
                <h2 class="text-xs font-black uppercase tracking-widest text-blue-400">Settings</h2>
                <p class="text-[9px] opacity-40 uppercase font-bold">System Configuration</p>
            </div>
            <button id="close-menu" class="interactive p-2 hover:bg-white/10 rounded-full text-white/70">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-5 space-y-6 custom-scroll">
            <!-- Solar Toggle -->
            <div class="bg-white/5 rounded-2xl p-5 border border-white/10">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-[10px] font-black uppercase tracking-widest text-yellow-400">Solar Real-Time</p>
                    <label class="toggle-switch interactive">
                        <input type="checkbox" id="solar-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="text-[9px] text-white/40 leading-relaxed">Prithvi par real-time suraj ki sthiti dikhayein.</p>
            </div>

            <!-- Optional Collapsible Polluted Cities -->
            <div class="space-y-2">
                <button onclick="toggleCities()" class="interactive w-full flex justify-between items-center bg-white/5 hover:bg-white/10 p-4 rounded-xl border border-white/10 transition-all">
                    <div class="text-left">
                        <p class="text-[10px] font-black uppercase tracking-widest text-red-500">Pollution Hotspots</p>
                        <p class="text-[8px] opacity-40 uppercase">Optional View</p>
                    </div>
                    <svg id="cities-chevron" class="w-4 h-4 text-white/40 chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                
                <div id="cities-collapse" class="space-y-2 pl-1 pr-1">
                    <div id="polluted-city-list" class="space-y-2 pt-2 pb-2"></div>
                </div>
            </div>
        </div>
        
        <div class="p-5 border-t border-white/5 bg-white/5">
            <button onclick="resetCamera()" class="interactive w-full py-4 glass text-[10px] font-black uppercase tracking-widest hover:bg-blue-500/20 transition-all">Reset Camera</button>
        </div>
    </div>

    <!-- UI Overlay -->
    <main class="ui-layer p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between items-start gap-4">
            <div class="flex gap-3 w-full md:w-auto">
                <div class="glass p-4 flex items-center gap-4 border-l-4 border-blue-500">
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                    <h1 class="text-[11px] font-black uppercase tracking-widest">Global Pulse</h1>
                </div>
                <button id="open-menu" class="interactive glass p-4 px-5 hover:bg-white/10 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>

            <div class="relative w-full md:w-[350px]">
                <div class="glass p-1.5 flex items-center pl-4 gap-2 border border-white/10">
                    <input id="search-input" type="text" placeholder="Sheher search karein..." class="interactive bg-transparent border-none outline-none text-sm w-full px-2 placeholder:text-white/20">
                    <button id="search-go" class="interactive bg-blue-600 hover:bg-blue-500 text-white p-2.5 px-5 rounded-xl text-[9px] font-black uppercase tracking-widest">Go</button>
                </div>
            </div>
        </div>

        <div class="mt-auto flex flex-col md:flex-row items-end justify-between gap-6">
            <div id="data-card" class="glass p-6 md:p-7 border-b-4 border-blue-500 transition-all w-full md:max-w-[580px]">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 id="city-name" class="text-4xl md:text-5xl font-black uppercase tracking-tighter">Delhi</h2>
                        <p id="country-name" class="text-[9px] uppercase opacity-40 font-bold tracking-[0.2em] mt-1">India</p>
                    </div>
                    <div class="text-right flex flex-col items-end gap-2">
                        <button onclick="getAIInsights()" class="interactive bg-blue-500/20 hover:bg-blue-500/40 text-blue-400 text-[9px] font-black uppercase tracking-widest px-4 py-2 rounded-xl border border-blue-500/30">
                            ✨ AI Analysis
                        </button>
                        <div>
                            <p class="text-[8px] uppercase font-black opacity-30">Air Quality Index</p>
                            <p id="aqi-val" class="text-4xl font-black leading-none">--</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                        <p class="text-[8px] uppercase font-black opacity-30 mb-1">Temperature</p>
                        <p class="text-xl font-black"><span id="temp-val">--</span><span class="text-xs text-blue-400">°</span></p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                        <p class="text-[8px] uppercase font-black opacity-30 mb-1">Humidity</p>
                        <p class="text-xl font-black"><span id="humidity-val">--</span><span class="text-xs text-blue-400">%</span></p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                        <div class="flex justify-between items-start mb-1">
                            <p class="text-[8px] uppercase font-black opacity-30">Noise</p>
                            <div id="noise-vis" class="flex gap-0.5 mt-0.5">
                                <div class="noise-dot"></div>
                                <div class="noise-dot" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                        <p class="text-xl font-black"><span id="noise-val">--</span><span class="text-[10px] text-blue-400 ml-0.5">dB</span></p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                        <p class="text-[8px] uppercase font-black opacity-30 mb-1">Weather</p>
                        <p id="weather-label" class="text-[9px] font-black uppercase text-blue-400 truncate tracking-tighter">Syncing...</p>
                    </div>
                </div>
                
                <div class="p-4 rounded-xl bg-white/5 border border-white/10 flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-[8px] font-black uppercase tracking-widest text-white/30 mb-1">Advisory</p>
                        <p id="advisory-box" class="text-[10px] font-semibold text-white/70 italic leading-snug">Data sync ho raha hai...</p>
                    </div>
                    <div id="aqi-status" class="risk-badge ml-4 shrink-0">Wait...</div>
                </div>
            </div>

            <div class="hidden md:block glass p-5 px-8 text-right">
                <p id="digital-clock" class="text-4xl font-black tracking-tighter">00:00:00</p>
                <p class="text-[7px] font-black opacity-20 tracking-[0.3em] uppercase mt-1">Satellite Time Sync</p>
            </div>
        </div>
    </main>

    <script>
        const apiKey = ""; 
        let scene, camera, renderer, globe, clouds, controls, marker, pulseMarker, sunLight, ambientLight, globeGroup;
        let isSolarSync = false;
        let currentCityData = { name: "Delhi", country: "India", aqi: 0, temp: 0, humidity: 0, noise: 0, weather: "" };

        const weatherMap = {
            0: "Saaf Aasman", 1: "Mainly Saaf", 2: "Thode Badal", 3: "Baadal",
            45: "Kohar (Fog)", 48: "Bhaari Kohar", 51: "Boonda-baandi", 53: "Drizzle",
            61: "Halki Baarish", 63: "Baarish", 71: "Snowfall", 80: "Bauchaar", 95: "Toofan"
        };

        const pollutedCities = [
            { name: "Lahore", lat: 31.52, lon: 74.35, country: "Pakistan", level: "Severe" },
            { name: "Delhi", lat: 28.61, lon: 77.20, country: "India", level: "Severe" },
            { name: "Dhaka", lat: 23.81, lon: 90.41, country: "Bangladesh", level: "High" },
            { name: "Karachi", lat: 24.86, lon: 67.00, country: "Pakistan", level: "High" },
            { name: "Beijing", lat: 39.90, lon: 116.40, country: "China", level: "High" },
            { name: "Mumbai", lat: 19.07, lon: 72.87, country: "India", level: "Moderate" },
            { name: "Cairo", lat: 30.04, lon: 31.23, country: "Egypt", level: "High" },
            { name: "Kolkata", lat: 22.57, lon: 88.36, country: "India", level: "High" },
            { name: "Baghdad", lat: 33.31, lon: 44.36, country: "Iraq", level: "Moderate" },
            { name: "Shenyang", lat: 41.80, lon: 123.43, country: "China", level: "High" }
        ];

        function handleLoading() {
            const bar = document.getElementById('progress-bar');
            const status = document.getElementById('status-text');
            const overlay = document.getElementById('loading-overlay');
            
            const steps = [
                { p: 20, t: "Initializing Neural Links..." },
                { p: 45, t: "Synchronizing Satellite Data..." },
                { p: 75, t: "Calibrating Environment Sensors..." },
                { p: 90, t: "Establishing Global Pulse..." },
                { p: 100, t: "Systems Online." }
            ];

            let i = 0;
            const interval = setInterval(() => {
                if(i < steps.length) {
                    bar.style.width = steps[i].p + "%";
                    status.innerText = steps[i].t;
                    i++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        overlay.style.opacity = '0';
                        overlay.style.transform = 'scale(1.1)';
                        setTimeout(() => overlay.style.display = 'none', 1000);
                    }, 500);
                }
            }, 600);
        }

        function toggleCities() {
            const collapse = document.getElementById('cities-collapse');
            const chevron = document.getElementById('cities-chevron');
            collapse.classList.toggle('expanded');
        }

        function formatAIResponse(text) {
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/### (.*?)$/gm, '<h3>$1</h3>');
            html = html.replace(/^(\d+\. )?<strong>(.*?)<\/strong>:/gm, '<h3>$2</h3>');
            html = html.replace(/^\* (.*?)$/gm, '<li>$1</li>');
            html = html.replace(/^- (.*?)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/gms, '<ul>$1</ul>');
            
            const lines = html.split('\n');
            const processedLines = lines.map(line => {
                if (line.trim() === '' || line.startsWith('<h') || line.startsWith('<ul') || line.startsWith('<li')) {
                    return line;
                }
                return `<p>${line}</p>`;
            });
            return processedLines.join('');
        }

        async function getAIInsights() {
            toggleAIModal(true);
            document.getElementById('ai-city-name').innerText = `${currentCityData.name}, ${currentCityData.country}`;
            const contentDiv = document.getElementById('ai-content');
            contentDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 space-y-4">
                    <div class="w-10 h-10 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-[10px] font-black uppercase tracking-[0.3em] text-blue-400 animate-pulse">Analyzing Global Pulse Data...</p>
                </div>
            `;

            const systemPrompt = "Aap ek environmental expert AI hain. User ko unke sheher ke AQI, temperature, noise aur weather ke base par health tips aur environment precautions dein Hindi (Latin) script mein. Apne response ko headings aur bullet points mein format karein.";
            const userQuery = `City: ${currentCityData.name}, ${currentCityData.country}. AQI: ${currentCityData.aqi}, Temperature: ${currentCityData.temp}°C, Humidity: ${currentCityData.humidity}%, Noise Level: ${currentCityData.noise}dB, Weather: ${currentCityData.weather}. Report taiyar karein.`;

            let retries = 0;
            const maxRetries = 5;
            
            async function callGemini() {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    
                    if (!response.ok) throw new Error("API Limit reached");
                    const data = await response.json();
                    const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Maafi chahte hain, analysis nahi ho paya.";
                    contentDiv.innerHTML = formatAIResponse(rawText);
                } catch (error) {
                    if (retries < maxRetries) {
                        retries++;
                        setTimeout(callGemini, Math.pow(2, retries) * 1000);
                    } else {
                        contentDiv.innerHTML = `<div class="p-6 text-center text-red-400">Engine busy hai, please retry later.</div>`;
                    }
                }
            }
            callGemini();
        }

        function toggleAIModal(show) {
            const modal = document.getElementById('ai-modal');
            if(show) modal.classList.add('open');
            else modal.classList.remove('open');
        }

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
            camera.position.z = window.innerWidth < 768 ? 550 : 450;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;

            globeGroup = new THREE.Group();
            scene.add(globeGroup);

            const loader = new THREE.TextureLoader();
            globe = new THREE.Mesh(
                new THREE.SphereGeometry(100, 64, 64),
                new THREE.MeshPhongMaterial({
                    map: loader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
                    bumpMap: loader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
                    bumpScale: 1.5, specular: new THREE.Color(0x222222)
                })
            );
            globeGroup.add(globe);

            clouds = new THREE.Mesh(
                new THREE.SphereGeometry(101.5, 64, 64),
                new THREE.MeshPhongMaterial({
                    map: loader.load('https://unpkg.com/three-globe/example/img/earth-clouds.png'),
                    transparent: true, opacity: 0.3
                })
            );
            globeGroup.add(clouds);

            ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            sunLight = new THREE.DirectionalLight(0xffffff, 1.0);
            sunLight.position.set(500, 300, 400); 
            scene.add(sunLight);

            marker = new THREE.Mesh(new THREE.CircleGeometry(2, 32), new THREE.MeshBasicMaterial({ color: 0x3b82f6, side: THREE.DoubleSide }));
            marker.visible = false;
            globeGroup.add(marker);

            pulseMarker = new THREE.Mesh(new THREE.RingGeometry(2.5, 5, 32), new THREE.MeshBasicMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.7, side: THREE.DoubleSide }));
            pulseMarker.visible = false;
            globeGroup.add(pulseMarker);

            setupUI();
            animate();
            handleLoading();
            fetchData("Delhi", "India", 28.61, 77.20);
        }

        function setupUI() {
            const sideMenu = document.getElementById('side-menu');
            const backdrop = document.getElementById('menu-backdrop');
            const openBtn = document.getElementById('open-menu');
            const closeBtn = document.getElementById('close-menu');
            
            const closeMenu = () => { sideMenu.classList.remove('open'); backdrop.classList.remove('open'); };
            const toggleMenu = () => {
                const isOpen = sideMenu.classList.contains('open');
                if (isOpen) closeMenu();
                else { sideMenu.classList.add('open'); backdrop.classList.add('open'); }
            };

            openBtn.onclick = (e) => { e.stopPropagation(); toggleMenu(); };
            closeBtn.onclick = closeMenu;
            backdrop.onclick = closeMenu;

            document.getElementById('solar-toggle').onchange = (e) => { isSolarSync = e.target.checked; };

            const searchInput = document.getElementById('search-input');
            const searchGo = document.getElementById('search-go');
            searchGo.onclick = async () => {
                const val = searchInput.value.trim();
                if(!val) return;
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${val}&count=1`);
                const data = await res.json();
                if(data.results?.[0]) {
                    const i = data.results[0];
                    fetchData(i.name, i.country, i.latitude, i.longitude);
                }
            };

            const pollutedList = document.getElementById('polluted-city-list');
            pollutedCities.forEach(c => {
                const div = document.createElement('div');
                div.className = "interactive p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-red-500/10 transition-all cursor-pointer";
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-[9px] font-black uppercase tracking-widest">${c.name}</p>
                            <p class="text-[7px] opacity-40 uppercase font-bold">${c.country}</p>
                        </div>
                        <span class="text-[7px] font-black px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 uppercase">${c.level}</span>
                    </div>
                `;
                div.onclick = () => fetchData(c.name, c.country, c.lat, c.lon);
                pollutedList.appendChild(div);
            });
        }

        async function fetchData(name, country, lat, lon) {
            document.getElementById('side-menu').classList.remove('open');
            document.getElementById('menu-backdrop').classList.remove('open');

            try {
                const [wRes, aRes] = await Promise.all([
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto`),
                    fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi&timezone=auto`)
                ]);
                const w = await wRes.json();
                const a = await aRes.json();
                
                const aqi = a.current.us_aqi;
                const wind = w.current.wind_speed_10m;
                const wCode = w.current.weather_code;
                const noise = Math.floor(40 + (aqi * 0.12) + (wind * 0.3) + Math.random() * 8);

                currentCityData = {
                    name, country, aqi, 
                    temp: Math.round(w.current.temperature_2m),
                    humidity: w.current.relative_humidity_2m,
                    noise,
                    weather: weatherMap[wCode] || "Variable"
                };

                document.getElementById('city-name').innerText = name;
                document.getElementById('country-name').innerText = country;
                document.getElementById('aqi-val').innerText = aqi;
                document.getElementById('temp-val').innerText = currentCityData.temp;
                document.getElementById('humidity-val').innerText = currentCityData.humidity;
                document.getElementById('noise-val').innerText = noise;
                document.getElementById('weather-label').innerText = currentCityData.weather;
                
                updateVisuals(aqi, noise);
                moveCamera(lat, lon);
            } catch(e) { console.error(e); }
        }

        function updateVisuals(aqi, noise) {
            const status = document.getElementById('aqi-status');
            const box = document.getElementById('advisory-box');
            const noiseVis = document.getElementById('noise-vis');
            let color = "#10b981", label = "Safe", msg = "Paryavaran santulit hai.";

            if(aqi > 200 || noise > 80) {
                color = "#ef4444"; label = "Critical";
                msg = "Severe condition! Sehat ka dhyan rakhein.";
            } else if(aqi > 70 || noise > 65) {
                color = "#fbbf24"; label = "Caution";
                msg = "Hawa aur shor ka star thoda zyada hai.";
            }

            status.innerText = label;
            status.style.color = color;
            status.style.background = `${color}20`;
            box.innerText = msg;
            document.getElementById('data-card').style.borderBottomColor = color;
            document.getElementById('aqi-val').style.color = color;
            noiseVis.style.color = color;
            
            marker.material.color.set(color);
            pulseMarker.material.color.set(color);
        }

        function moveCamera(lat, lon) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            const r = 101.5;
            const x = -(r * Math.sin(phi) * Math.cos(theta));
            const y = r * Math.cos(phi);
            const z = r * Math.sin(phi) * Math.sin(theta);
            
            marker.position.set(x, y, z);
            marker.lookAt(0, 0, 0);
            marker.visible = true;
            pulseMarker.position.set(x, y, z);
            pulseMarker.lookAt(0, 0, 0);
            pulseMarker.visible = true;

            controls.autoRotate = false;
            gsap.to(camera.position, { 
                x: x * 3.5, y: y * 3.5, z: z * 3.5, duration: 2, 
                onComplete: () => { if(marker.visible) controls.autoRotate = true; } 
            });
        }

        function resetCamera() {
            gsap.to(camera.position, { x: 0, y: 0, z: 450, duration: 2 });
            marker.visible = false; pulseMarker.visible = false;
            controls.autoRotate = true;
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if(clouds) clouds.rotation.y += 0.0001;
            if(pulseMarker.visible) {
                const s = 1 + (Math.sin(Date.now() * 0.005) + 1) * 0.5;
                pulseMarker.scale.set(s, s, s);
                pulseMarker.material.opacity = 0.8 - (s-1);
            }
            if(isSolarSync) {
                const now = new Date();
                const utcHours = now.getUTCHours() + now.getUTCMinutes() / 60;
                const sunLon = -((utcHours / 24) * 360 - 180); 
                sunLight.position.set(-(500 * Math.sin(Math.PI/2) * Math.cos((sunLon+180)*Math.PI/180)), 300, 500 * Math.sin(Math.PI/2) * Math.sin((sunLon+180)*Math.PI/180));
                ambientLight.intensity = 0.3;
            } else {
                sunLight.position.set(500, 300, 400);
                ambientLight.intensity = 0.7;
            }
            renderer.render(scene, camera);
        }

        setInterval(() => {
            document.getElementById('digital-clock').innerText = new Date().toLocaleTimeString('en-GB');
        }, 1000);

        window.onload = init;
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
