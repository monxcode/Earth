<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Pulse - Adaptive AQI Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        body { margin: 0; overflow: hidden; font-family: 'Plus Jakarta Sans', sans-serif; background-color: #000; color: white; transition: background 1.5s ease; }
        .glass { background: rgba(10, 10, 20, 0.6); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .ui-layer { position: relative; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }
        #side-menu { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #side-menu.active { transform: translateX(0); }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: currentColor; opacity: 0.3; animation: scan 4s linear infinite; }
        @keyframes scan { 0% { top: 0% } 100% { top: 100% } }
        .btn-press:active { transform: scale(0.95); }
        #suggestions-box { max-height: 250px; overflow-y: auto; display: none; z-index: 100; }
        .suggestion-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .suggestion-item:hover { background: rgba(255, 255, 255, 0.1); }
        
        /* Dynamic Glows */
        .aqi-glow { transition: text-shadow 1s ease, color 1s ease; }
        .bg-overlay { position: fixed; inset: 0; pointer-events: none; transition: background 2s ease; z-index: 0; opacity: 0.4; }
    </style>
</head>
<body class="bg-black">
    <div id="dynamic-bg" class="bg-overlay"></div>

    <div id="loading-overlay" class="fixed inset-0 z-[300] bg-black flex flex-col items-center justify-center gap-4 transition-opacity duration-1000">
        <div class="w-16 h-16 border-4 border-t-blue-500 border-white/10 rounded-full animate-spin"></div>
        <p class="text-[10px] uppercase font-bold tracking-[0.3em] text-blue-400">Atmosphere loading...</p>
    </div>

    <!-- Side Menu -->
    <div id="side-menu" class="fixed top-0 right-0 h-full w-80 glass z-[200] rounded-none border-l border-white/10 p-6 flex flex-col gap-6 shadow-2xl overflow-y-auto">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-[10px] font-black uppercase tracking-widest text-blue-400">Analyzer Menu</h2>
            <button id="close-menu" class="interactive btn-press text-xl">✕</button>
        </div>
        
        <div class="space-y-6">
            <div class="p-4 bg-white/5 rounded-2xl border border-white/10">
                <p class="text-[9px] uppercase font-bold text-white/50 mb-4 tracking-widest">Top 10 Polluted Cities</p>
                <div id="top-polluted-list" class="space-y-2"></div>
            </div>

            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                <p class="text-[8px] uppercase font-bold opacity-30 mb-2">AQI Scale (U.S. Standard)</p>
                <div class="space-y-2 text-[9px] font-bold uppercase tracking-tighter">
                    <div class="flex justify-between items-center"><span class="text-emerald-400">0-50 Good</span><div class="w-2 h-2 rounded-full bg-emerald-400"></div></div>
                    <div class="flex justify-between items-center"><span class="text-yellow-400">51-100 Moderate</span><div class="w-2 h-2 rounded-full bg-yellow-400"></div></div>
                    <div class="flex justify-between items-center"><span class="text-orange-400">101-150 Sensitive</span><div class="w-2 h-2 rounded-full bg-orange-400"></div></div>
                    <div class="flex justify-between items-center"><span class="text-red-500">151+ Unhealthy</span><div class="w-2 h-2 rounded-full bg-red-500"></div></div>
                </div>
            </div>
            
            <button onclick="resetRotation()" class="interactive w-full glass p-4 text-[9px] font-bold uppercase tracking-widest text-center hover:bg-white/5 transition-colors">Reset World View</button>
        </div>
    </div>

    <div id="canvas-container"></div>

    <main class="ui-layer min-h-screen flex flex-col justify-between p-6 md:p-10">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div id="brand-box" class="interactive glass p-4 px-6 border-t-2 border-blue-400 flex items-center gap-4 relative overflow-hidden transition-all duration-1000">
                <div class="scan-line text-blue-400"></div>
                <div id="status-indicator" class="w-3 h-3 rounded-full bg-blue-400 shadow-[0_0_15px_#00d1ff] transition-all duration-1000"></div>
                <div>
                    <h1 class="text-xs font-bold uppercase tracking-widest">Global Pulse</h1>
                    <p class="text-[9px] opacity-60 uppercase">Atmospheric Adaptive Engine</p>
                </div>
            </div>

            <div class="flex flex-col gap-2 relative w-full md:w-80">
                <div class="interactive glass p-2 flex items-center pl-4 group">
                    <input id="location-input" type="text" autocomplete="off" placeholder="Search city..." class="bg-transparent border-none outline-none text-sm w-full placeholder:text-white/20">
                    <button id="search-btn" class="p-2 ml-2 bg-white/5 hover:bg-white/10 rounded-lg transition-colors">
                        <svg class="w-4 h-4 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                    <button id="open-menu" class="ml-2 p-2 hover:bg-white/5 btn-press rounded-lg">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
                <div id="suggestions-box" class="interactive absolute top-full left-0 w-full mt-2 glass border border-white/10 rounded-xl overflow-hidden shadow-2xl"></div>
            </div>
        </header>

        <div class="flex flex-col md:flex-row items-end justify-between gap-6">
            <div class="w-full md:w-96">
                <div id="info-panel" class="interactive glass p-6 border-l-4 border-blue-400 transition-all duration-1000">
                    <h2 id="display-city" class="text-3xl md:text-5xl font-black uppercase tracking-tighter mb-1 leading-none">Earth</h2>
                    <p id="display-country" class="text-[10px] uppercase opacity-40 font-bold tracking-widest mb-6">Scanning Global Nodes</p>
                    
                    <div class="mb-4 p-4 bg-white/5 rounded-2xl border border-white/5 flex items-center justify-between">
                        <div>
                            <p class="text-[8px] uppercase font-bold opacity-30 mb-1">AQI Status</p>
                            <p id="stat-aqi-label" class="text-[10px] font-black uppercase tracking-widest aqi-glow">Scanning...</p>
                        </div>
                        <p id="stat-aqi" class="text-4xl font-black aqi-glow transition-all duration-1000">--</p>
                    </div>

                    <div id="health-advisory-box" class="mb-6 p-4 rounded-xl border border-white/5 bg-white/5">
                        <p class="text-[8px] uppercase font-bold opacity-30 mb-2">Safety Advisory (Bachar Sujhav)</p>
                        <div class="flex items-start gap-3">
                            <div id="advisory-icon" class="w-2 h-2 rounded-full mt-1.5 transition-all duration-1000"></div>
                            <p id="advisory-text" class="text-[10px] font-semibold leading-relaxed text-white/90">Awaiting location coordinate sync...</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                            <p class="text-[8px] uppercase font-bold opacity-30 mb-1">Temp</p>
                            <p class="text-xl font-black"><span id="stat-temp">--</span>°C</p>
                        </div>
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                            <p class="text-[8px] uppercase font-bold opacity-30 mb-1">Humidity</p>
                            <p class="text-xl font-black"><span id="stat-humidity">--</span>%</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="hidden md:block glass p-6 text-right">
                <p id="clock" class="text-4xl font-black tracking-tighter">00:00:00</p>
                <p class="text-[9px] font-bold uppercase opacity-30 tracking-widest">Atmos Sync Active</p>
            </div>
        </div>
    </main>

    <script>
        let scene, camera, renderer, earth, atmosphere, controls, marker;
        const topCities = [
            { name: "Baghdad", country: "Iraq", lat: 33.3152, lon: 44.3661 },
            { name: "Delhi", country: "India", lat: 28.6139, lon: 77.2090 },
            { name: "Dhaka", country: "Bangladesh", lat: 23.8103, lon: 90.4125 },
            { name: "Lahore", country: "Pakistan", lat: 31.5204, lon: 74.3587 },
            { name: "Kolkata", country: "India", lat: 22.5726, lon: 88.3639 },
            { name: "Beijing", country: "China", lat: 39.9042, lon: 116.4074 },
            { name: "Mumbai", country: "India", lat: 19.0760, lon: 72.8777 },
            { name: "Tashkent", country: "Uzbekistan", lat: 41.2995, lon: 69.2401 },
            { name: "Karachi", country: "Pakistan", lat: 24.8607, lon: 67.0011 },
            { name: "Dubai", country: "UAE", lat: 25.2048, lon: 55.2708 }
        ];

        function updateUITheme(aqi) {
            let color, hex, bg;
            if (aqi <= 50) {
                color = 'text-emerald-400';
                hex = 0x10b981; 
                bg = 'radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.3) 0%, transparent 70%)';
                document.getElementById('advisory-text').innerText = "Hawa bilkul saaf hai! Bahar ka mausam enjoy karein.";
                document.getElementById('stat-aqi-label').innerText = 'Good';
            } else if (aqi <= 100) {
                color = 'text-yellow-400';
                hex = 0xfacc15;
                bg = 'radial-gradient(circle at 50% 50%, rgba(250, 204, 21, 0.3) 0%, transparent 70%)';
                document.getElementById('advisory-text').innerText = "Hawa thik-thak hai, par thodi dhool mitti ho sakti hai.";
                document.getElementById('stat-aqi-label').innerText = 'Moderate';
            } else if (aqi <= 150) {
                color = 'text-orange-400';
                hex = 0xfb923c;
                bg = 'radial-gradient(circle at 50% 50%, rgba(251, 146, 60, 0.3) 0%, transparent 70%)';
                document.getElementById('advisory-text').innerText = "Buzurgon aur bachon ko saavdhan rehne ki zarurat hai.";
                document.getElementById('stat-aqi-label').innerText = 'Sensitive';
            } else {
                color = 'text-red-500';
                hex = 0xef4444;
                bg = 'radial-gradient(circle at 50% 50%, rgba(239, 68, 68, 0.4) 0%, transparent 70%)';
                document.getElementById('advisory-text').innerText = "Danger! Pollution kaafi zyada hai. Mask ka upyog karein.";
                document.getElementById('stat-aqi-label').innerText = 'Unhealthy';
            }

            // UI Elements Update
            const aqiText = document.getElementById('stat-aqi');
            const aqiLabel = document.getElementById('stat-aqi-label');
            const indicator = document.getElementById('status-indicator');
            const brandBox = document.getElementById('brand-box');
            const infoPanel = document.getElementById('info-panel');
            const advisorIcon = document.getElementById('advisory-icon');
            const dynamicBg = document.getElementById('dynamic-bg');

            aqiText.className = `text-4xl font-black aqi-glow ${color}`;
            aqiLabel.className = `text-[10px] font-black uppercase tracking-widest aqi-glow ${color}`;
            indicator.style.backgroundColor = `currentColor`;
            indicator.className = `w-3 h-3 rounded-full shadow-[0_0_15px_rgba(255,255,255,0.5)] ${color}`;
            brandBox.style.borderColor = `currentColor`;
            brandBox.className = `interactive glass p-4 px-6 border-t-2 flex items-center gap-4 relative overflow-hidden transition-all duration-1000 ${color}`;
            infoPanel.style.borderColor = `currentColor`;
            infoPanel.className = `interactive glass p-6 border-l-4 transition-all duration-1000 ${color}`;
            advisorIcon.className = `w-2 h-2 rounded-full mt-1.5 animate-pulse transition-all duration-1000 ${color.replace('text-', 'bg-')}`;
            dynamicBg.style.background = bg;

            // Globe Atmosphere Update
            if (atmosphere) {
                gsap.to(atmosphere.material.uniforms.vColor ? atmosphere.material.uniforms.vColor.value : {}, {
                   r: (hex >> 16 & 255) / 255,
                   g: (hex >> 8 & 255) / 255,
                   b: (hex & 255) / 255,
                   duration: 1.5
                });
                // Since basic fragment shader doesn't have uniforms, we'll recreate the glow material subtly
                atmosphere.material.fragmentShader = `
                    varying vec3 vNormal;
                    void main() { 
                        float intensity = pow(0.65 - dot(vNormal, vec3(0, 0, 1.0)), 6.0); 
                        gl_FragColor = vec4(${(hex >> 16 & 255) / 255}, ${(hex >> 8 & 255) / 255}, ${(hex & 255) / 255}, 1.0) * intensity; 
                    }
                `;
                atmosphere.material.needsUpdate = true;
            }
        }

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 4;
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;
            controls.minDistance = 2.1;
            
            const texLoader = new THREE.TextureLoader();
            const earthMat = new THREE.MeshPhongMaterial({
                map: texLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
                bumpMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
                bumpScale: 0.05,
                specular: new THREE.Color('#111'),
                shininess: 5
            });
            earth = new THREE.Mesh(new THREE.SphereGeometry(1, 128, 128), earthMat);
            scene.add(earth);

            const glowGeo = new THREE.SphereGeometry(1.15, 128, 128);
            const glowMat = new THREE.ShaderMaterial({
                vertexShader: `
                    varying vec3 vNormal;
                    void main() { vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }
                `,
                fragmentShader: `
                    varying vec3 vNormal;
                    void main() { float intensity = pow(0.65 - dot(vNormal, vec3(0, 0, 1.0)), 6.0); gl_FragColor = vec4(0.2, 0.5, 1.0, 1.0) * intensity; }
                `,
                side: THREE.BackSide, blending: THREE.AdditiveBlending, transparent: true
            });
            atmosphere = new THREE.Mesh(glowGeo, glowMat);
            scene.add(atmosphere);

            const starsGeo = new THREE.BufferGeometry();
            const starsPos = [];
            for(let i=0; i<6000; i++) starsPos.push((Math.random()-0.5)*1500, (Math.random()-0.5)*1500, (Math.random()-0.5)*1500);
            starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starsPos, 3));
            scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({color: 0x444444, size: 0.5})));

            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(5, 3, 5);
            scene.add(sun);

            marker = new THREE.Mesh(new THREE.RingGeometry(0.015, 0.025, 32), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, side: THREE.DoubleSide }));
            marker.visible = false;
            scene.add(marker);

            populateTopCities();
            animate();
            
            setTimeout(() => {
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 1000);
            }, 1000);

            fetchData("Delhi", "India", 28.6, 77.2);
        }

        async function fetchData(name, country, lat, lon) {
            try {
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`);
                const weatherData = await weatherRes.json();
                const aqiRes = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi&timezone=auto`);
                const aqiData = await aqiRes.json();
                
                const aqi = aqiData.current.us_aqi;
                document.getElementById('display-city').innerText = name;
                document.getElementById('display-country').innerText = country;
                document.getElementById('stat-temp').innerText = Math.round(weatherData.current.temperature_2m);
                document.getElementById('stat-humidity').innerText = weatherData.current.relative_humidity_2m;
                document.getElementById('stat-aqi').innerText = aqi;

                updateUITheme(aqi);
                
                const r = 1.01;
                const phi = (90 - lat) * (Math.PI / 180);
                const theta = (lon + 180) * (Math.PI / 180);
                const x = -(r * Math.sin(phi) * Math.cos(theta));
                const y = r * Math.cos(phi);
                const z = r * Math.sin(phi) * Math.sin(theta);
                
                marker.position.set(x, y, z);
                marker.lookAt(0, 0, 0);
                marker.visible = true;
                gsap.killTweensOf(marker.scale);
                gsap.to(marker.scale, { x: 5, y: 5, z: 5, duration: 1.5, repeat: -1 });
                gsap.to(camera.position, { x: x * 2.6, y: y * 2.6, z: z * 2.6, duration: 2, ease: "power2.inOut" });
            } catch(e) { console.error(e); }
        }

        function populateTopCities() {
            const list = document.getElementById('top-polluted-list');
            topCities.forEach((city, idx) => {
                const btn = document.createElement('button');
                btn.className = "interactive w-full flex items-center justify-between p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-all text-left mb-1 group";
                btn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-[9px] font-black opacity-20 group-hover:opacity-100">${idx + 1}</span>
                        <div>
                            <div class="text-[10px] font-black uppercase text-white/80">${city.name}</div>
                            <div class="text-[8px] uppercase opacity-40">${city.country}</div>
                        </div>
                    </div>
                `;
                btn.onclick = () => { fetchData(city.name, city.country, city.lat, city.lon); document.getElementById('side-menu').classList.remove('active'); };
                list.appendChild(btn);
            });
        }

        document.getElementById('location-input').addEventListener('input', async (e) => {
            const val = e.target.value.trim();
            if(val.length < 3) { document.getElementById('suggestions-box').style.display = 'none'; return; }
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${val}&count=5`);
            const data = await res.json();
            if(data.results) {
                document.getElementById('suggestions-box').innerHTML = data.results.map(c => `
                    <div class="suggestion-item" onclick="fetchData('${c.name}', '${c.country}', ${c.latitude}, ${c.longitude}); document.getElementById('suggestions-box').style.display = 'none';">
                        <div class="text-[10px] font-black uppercase">${c.name}</div>
                        <div class="text-[8px] opacity-40 uppercase">${c.country || ''}</div>
                    </div>
                `).join('');
                document.getElementById('suggestions-box').style.display = 'block';
            }
        });

        document.getElementById('open-menu').onclick = () => document.getElementById('side-menu').classList.add('active');
        document.getElementById('close-menu').onclick = () => document.getElementById('side-menu').classList.remove('active');
        function resetRotation() { gsap.to(camera.position, { x: 0, y: 0, z: 4, duration: 2 }); marker.visible = false; }
        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB', { hour12: false }); }, 1000);
        window.onload = initThree;
    </script>
</body>
</html>

